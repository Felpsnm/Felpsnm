name: Update now playing

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

concurrency:
  group: now-playing
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Update inline SVG in README
        env:
          LASTFM_USER: ${{ secrets.LASTFM_USER }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
        run: python scripts/lastfm_now_playing.py

      - name: Update README img src to latest svg
        run: |
          python - <<'PY'
          import re
          from pathlib import Path

          latest = Path("assets/now-playing.latest").read_text(encoding="utf-8").strip()
          readme = Path("README.md")
          s = readme.read_text(encoding="utf-8")

          start = "<!-- NOW_PLAYING:START -->"
          end = "<!-- NOW_PLAYING:END -->"

          block = f"""{start}
          <img src="assets/{latest}" width="720" height="90" alt="Now playing" />
          {end}"""

          pattern = re.compile(re.escape(start) + r".*?" + re.escape(end), re.DOTALL)
          if not pattern.search(s):
            raise SystemExit("NOW_PLAYING markers not found in README.md")

          s2 = pattern.sub(block, s)
          readme.write_text(s2, encoding="utf-8")
          print("README updated to", latest)
          PY

      - name: Commit changes (only if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md assets/now-playing-*.svg assets/now-playing.id assets/now-playing.latest
          git diff --cached --quiet && exit 0
          git commit -m "chore: update now playing (inline)"
          git push
